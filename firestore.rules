rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user is caregiver
    function isCaregiver() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'caregiver';
    }
    
    // Check if user is client
    function isClient() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'client';
    }
    
    // Check if user is owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if user is admin or owner
    function isAdminOrOwner(userId) {
      return isAdmin() || isOwner(userId);
    }
    
    // Check if caregiver is verified
    function isCaregiverVerified() {
      return isCaregiver() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verificationStatus == 'approved';
    }
    
    // ============================================
    // OTP CODES COLLECTION
    // ============================================
    match /otp_codes/{email} {
      // Allow read/write for authentication flow
      allow read, write: if true;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Public read access for verified caregivers (for search functionality)
      allow get, list: if resource.data.role == 'caregiver' && 
                          resource.data.verificationStatus == 'approved';
      
      // Admin has full access to all users
      allow read, write: if isAdmin();
      
      // Authenticated users can read all user data (needed for bookings, chat, etc.)
      allow get, list: if isAuthenticated();
      
      // Allow creating own user document during signup
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Allow updates by owner (profile edits)
      allow update: if isOwner(userId) || isAdmin();
      
      // Onboarding subcollection
      match /onboarding/{document} {
        allow read, write: if isAdmin() || isOwner(userId);
      }
      
      // Favorites subcollection
      match /favorites/{caregiverId} {
        allow read, write: if isAdmin() || isOwner(userId);
      }
      
      // Document history subcollection
      match /document_history/{documentId} {
        allow read, write: if isAdmin() || isOwner(userId);
      }
    }
    
    // ============================================
    // CARETAKER PROFILES COLLECTION (Legacy)
    // ============================================
    match /caretaker_profiles/{profileId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isAuthenticated();
    }
    
    // ============================================
    // BOOKINGS COLLECTION (Enhanced for 13-stage flow)
    // ============================================
    match /bookings/{bookingId} {
      // Read access:
      // - Admin: all bookings
      // - Authenticated users: all bookings (needed for dashboard stats and filtering)
      allow get, list: if isAuthenticated() || isAdmin();
      
      // Create access:
      // - Any authenticated user can create bookings
      allow create: if isAuthenticated();
      
      // Update access:
      // - Admin: all bookings
      // - Authenticated users: all bookings (needed for session management, status updates)
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete access: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // REVIEWS COLLECTION
    // ============================================
    match /reviews/{reviewId} {
      // Read: Public access
      allow read: if true;
      
      // Create: Authenticated users who completed a booking
      allow create: if isAuthenticated();
      
      // Update/Delete: Admin or review author
      allow update, delete: if isAdmin() || 
                               (isAuthenticated() && resource.data.clientId == request.auth.uid);
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Read: All authenticated users (needed for notification bell)
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user or system
      allow create: if isAuthenticated() || isAdmin();
      
      // Update: Any authenticated user (for marking as read)
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Any authenticated user or admin
      allow delete: if isAuthenticated() || isAdmin();
    }
    
    // ============================================
    // VERIFICATIONS COLLECTION
    // ============================================
    match /verifications/{verificationId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // VERIFICATION REQUESTS COLLECTION
    // ============================================
    match /verification_requests/{requestId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    match /chats/{chatId} {
      // Read: Admin or chat participants (allow list queries for all authenticated users)
      allow list: if isAuthenticated();
      allow get: if isAdmin() || 
                    (isAuthenticated() && request.auth.uid in resource.data.participants);
      
      // Create: Authenticated users
      allow create: if isAuthenticated();
      
      // Update: Admin or chat participants
      allow update: if isAdmin() || 
                       (isAuthenticated() && request.auth.uid in resource.data.participants);
      
      // Delete: Admin only
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write: if isAdmin() || 
                              (isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      }
    }
    
    // ============================================
    // CARE PLANS COLLECTION
    // ============================================
    match /care_plans/{planId} {
      // Read: Admin, client owner, or assigned caregiver
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.clientId == request.auth.uid) ||
                     (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Create: Authenticated clients
      allow create: if isAuthenticated() && isClient();
      
      // Update: Admin, client owner, or assigned caregiver
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.clientId == request.auth.uid) ||
                       (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Delete: Admin or client owner
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.clientId == request.auth.uid);
    }
    
    // ============================================
    // PAYMENTS COLLECTION
    // ============================================
    match /payments/{paymentId} {
      // Read: Admin, payer, or payee
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.clientId == request.auth.uid) ||
                     (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Create: Authenticated clients
      allow create: if isAuthenticated() && isClient();
      
      // Update: Admin only (for payment status updates)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // WALLET TRANSACTIONS COLLECTION (New for Stage 11)
    // ============================================
    match /wallet_transactions/{transactionId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // REFUNDS COLLECTION (New for Stage 13)
    // ============================================
    match /refunds/{refundId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user or admin
      allow create: if isAuthenticated() || isAdmin();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // AVAILABILITY COLLECTION
    // ============================================
    match /availability/{availabilityId} {
      // Read: Public access (for booking availability check)
      allow read: if true;
      
      // Create/Update: Caregivers for their own availability
      allow create, update: if isAuthenticated() && 
                               (isAdmin() || resource.data.caregiverId == request.auth.uid);
      
      // Delete: Admin or availability owner
      allow delete: if isAdmin() || 
                       (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
    }
    
    // ============================================
    // STORED DOCUMENTS COLLECTION
    // ============================================
    match /stored_documents/{docId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Any authenticated user or admin
      allow delete: if isAuthenticated() || isAdmin();
    }
    
    // ============================================
    // AUDIT LOGS COLLECTION (Admin only)
    // ============================================
    match /audit_logs/{logId} {
      // Read: Admin only
      allow read: if isAdmin();
      
      // Create: System/authenticated users
      allow create: if isAuthenticated();
      
      // Update: Never (logs are immutable)
      allow update: if false;
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // EARNINGS COLLECTION (Caregiver payouts)
    // ============================================
    match /earnings/{earningId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user or admin
      allow create: if isAuthenticated() || isAdmin();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // DISPUTES COLLECTION (New for dispute tracking)
    // ============================================
    match /disputes/{disputeId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated() || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Any authenticated user or admin
      allow update: if isAuthenticated() || isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // MODULE 4: SESSION MANAGEMENT
    // ============================================
    
    // CARE SESSIONS COLLECTION (Session execution tracking)
    match /care_sessions/{sessionId} {
      // Read: Admin, client, or assigned caregiver
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.clientId == request.auth.uid) ||
                     (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Create: Authenticated caregivers starting a session
      allow create: if isAuthenticated() && isCaregiver();
      
      // Update: Admin or assigned caregiver
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ============================================
    // MODULE 5: SAFETY & QUALITY ASSURANCE
    // ============================================
    
    // INCIDENTS COLLECTION (Incident reporting system)
    match /incidents/{incidentId} {
      // Read: Reporter, involved parties (client/caregiver), or admin
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.reporterId == request.auth.uid) ||
                     (isAuthenticated() && resource.data.caregiverId == request.auth.uid) ||
                     (isAuthenticated() && resource.data.clientId == request.auth.uid);
      
      // List: Admin sees all, users see only their related incidents
      allow list: if isAdmin() || isAuthenticated();
      
      // Create: Any authenticated user can report incidents
      allow create: if isAuthenticated();
      
      // Update: Assigned admin or any admin
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.assignedTo == request.auth.uid);
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // QUALITY METRICS COLLECTION (Caregiver performance metrics)
    match /quality_metrics/{metricId} {
      // Read: Caregiver (own metrics only) or admin
      allow read: if isAdmin() || 
                     (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // List: Admin only (for dashboards and analytics)
      allow list: if isAdmin();
      
      // Write: Admin only (automated metric calculation)
      allow create, update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // PLATFORM METRICS COLLECTION (Platform-wide analytics)
    match /platform_metrics/{metricId} {
      // Read: Admin only
      allow read: if isAdmin();
      
      // Write: Admin only (automated)
      allow create, update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ADMIN ALERTS COLLECTION (Critical incident alerts)
    match /admin_alerts/{alertId} {
      // Read: Admin only
      allow read: if isAdmin();
      
      // Create: System or admin (automated)
      allow create: if isAdmin() || isAuthenticated();
      
      // Update: Admin only (for acknowledging alerts)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // ============================================
    // MODULE 6: PAYMENT & BILLING SYSTEM
    // ============================================

    // TRANSACTIONS COLLECTION
    match /transactions/{transactionId} {
      // Read: Admin, transaction client, or transaction caregiver
      allow read: if isAdmin() 
                  || resource.data.clientId == request.auth.uid
                  || resource.data.caregiverId == request.auth.uid;
      
      // List: Admin or own transactions
      allow list: if isAdmin() 
                  || request.auth.uid != null;
      
      // Create: System/Backend only (via Cloud Functions)
      allow create: if false;
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // WALLETS COLLECTION
    match /wallets/{walletId} {
      // Read: Wallet owner or admin
      allow read: if isAdmin() || resource.data.userId == request.auth.uid;
      
      // List: Admin only
      allow list: if isAdmin();
      
      // Create: System only
      allow create: if false;
      
      // Update: Admin or system only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // WALLET TRANSACTIONS COLLECTION
    match /wallet_transactions/{walletTxnId} {
      // Read: Wallet owner or admin
      allow read: if isAdmin();
      
      // List: Admin only
      allow list: if isAdmin();
      
      // Create/Update/Delete: System only
      allow create, update, delete: if false;
    }

    // PAYOUTS COLLECTION
    match /payouts/{payoutId} {
      // Read: Payout caregiver or admin
      allow read: if isAdmin() || resource.data.caregiverId == request.auth.uid;
      
      // List: Admin or own payouts
      allow list: if isAdmin() 
                  || (isCaregiver() && resource.data.caregiverId == request.auth.uid);
      
      // Create: Caregiver requesting payout
      allow create: if isCaregiver() && request.resource.data.caregiverId == request.auth.uid;
      
      // Update: Admin only (processing payouts)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // INVOICES COLLECTION
    match /invoices/{invoiceId} {
      // Read: Invoice client, caregiver, or admin
      allow read: if isAdmin() 
                  || resource.data.clientId == request.auth.uid
                  || resource.data.caregiverId == request.auth.uid;
      
      // List: Admin or own invoices
      allow list: if isAdmin() || request.auth.uid != null;
      
      // Create: System only (auto-generated)
      allow create: if false;
      
      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // REFUNDS COLLECTION
    match /refunds/{refundId} {
      // Read: Refund client, caregiver, or admin
      allow read: if isAdmin() 
                  || resource.data.clientId == request.auth.uid
                  || resource.data.caregiverId == request.auth.uid;
      
      // List: Admin or involved parties
      allow list: if isAdmin() || request.auth.uid != null;
      
      // Create: Client or caregiver requesting refund
      allow create: if isAuthenticated() && request.resource.data.requestedBy == request.auth.uid;
      
      // Update: Admin only (approval/processing)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // CANCELLATION POLICIES COLLECTION
    match /cancellation_policies/{policyId} {
      // Read: All authenticated users
      allow read, list: if isAuthenticated();
      
      // Create/Update/Delete: Admin only
      allow create, update, delete: if isAdmin();
    }

    // BILLS COLLECTION (Enhanced billing with cost breakdown)
    match /bills/{billId} {
      // Read: Bill client, caregiver, or admin
      allow read: if isAdmin() 
                  || resource.data.clientId == request.auth.uid
                  || resource.data.caregiverId == request.auth.uid;
      
      // List: Admin or own bills
      allow list: if isAdmin() || request.auth.uid != null;
      
      // Create: System only (auto-generated from bookings)
      allow create: if isAdmin() || isAuthenticated();
      
      // Update: Admin only (for approval, disputes, status changes)
      allow update: if isAdmin() || 
                       (isAuthenticated() && resource.data.clientId == request.auth.uid) ||
                       (isAuthenticated() && resource.data.caregiverId == request.auth.uid);
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
  }
}
